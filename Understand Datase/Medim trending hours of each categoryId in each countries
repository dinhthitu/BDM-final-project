# -*- coding: utf-8 -*-
"""Thời gian lên xu hướng theo thể loại tại 5 quốc gia"""
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

# Tên quốc gia (tiếng Việt + mã)
countries = {
    'US': 'Mỹ', 
    'IN': 'Ấn Độ',
    'BR': 'Brazil',
    'GB': 'Anh',
    'KR': 'Hàn Quốc'
}

# Load data và lọc 5 quốc gia
df = pd.read_csv('processed_trending.csv')
df = df[df['country'].isin(countries.keys())]

# Thiết lập style
plt.style.use('seaborn')
sns.set_palette("husl")
plt.rcParams['font.family'] = 'DejaVu Sans'  # Hỗ trợ Unicode

# Vẽ biểu đồ cho từng quốc gia
for code, name in countries.items():
    # Lọc dữ liệu
    country_df = df[df['country'] == code]
    
    # Tính giờ trung bình
    median_hours = country_df.groupby('categoryId')['hours_to_trend'].median().sort_values()
    
    # Tạo biểu đồ
    plt.figure(figsize=(10, 5))
    ax = sns.barplot(x=median_hours.index, 
                    y=median_hours.values,
                    order=median_hours.index)
    
    # Tiêu đề và nhãn (tiếng Việt)
    plt.title(f'Thời gian lên xu hướng theo thể loại - {name} ({code})', pad=15)
    plt.xlabel('Thể loại')
    plt.ylabel('Giờ trung bình')
    plt.xticks(rotation=45, ha='right')
    
    # Hiển thị giá trị
    for p in ax.patches:
        ax.annotate(f"{p.get_height():.1f}", 
                   (p.get_x() + p.get_width() / 2., p.get_height()),
                   ha='center', va='center', 
                   xytext=(0, 5), 
                   textcoords='offset points')
    
    # Lưu và hiển thị
    plt.tight_layout()
    plt.savefig(f'gio_len_xu_huong_{code}.png', dpi=300)
    plt.show()
    
    # Xuất thống kê
    print(f"\nQUỐC GIA: {name} ({code})")
    print("Thể loại nhanh nhất:")
    print(median_hours.head(3).to_string())
    print("\nThể loại chậm nhất:")
    print(median_hours.tail(3).to_string())
    print("\n" + "="*50)
