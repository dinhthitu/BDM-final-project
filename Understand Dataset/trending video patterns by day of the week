import pandas as pd
import json
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime

def analyze_trending_patterns(csv_path, json_path):
    """Phân tích trending với 2 biểu đồ chính"""
    # 1. Load và tiền xử lý
    df = pd.read_csv(csv_path)
    with open(json_path) as f:
        categories = {int(k):v for k,v in json.load(f).items()}
    
    # 2. Chuẩn hóa datetime
    df['trending_date'] = pd.to_datetime(df['trending_date'])
    df['publishedAt'] = pd.to_datetime(df['publishedAt'])
    df['day_of_week'] = df['trending_date'].dt.day_name()
    df['category_name'] = df['categoryId'].map(categories)
    
    # 3. Tạo figure lớn chứa 2 biểu đồ
    plt.figure(figsize=(20, 10))
    
    # --- BIỂU ĐỒ 1: PHÂN BỔ THEO NGÀY VÀ DANH MỤC ---
    plt.subplot(1, 2, 1)
    day_order = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']
    heatmap_data = df.groupby(['day_of_week', 'category_name']).size().unstack().fillna(0).reindex(day_order)
    
    # Lọc chỉ hiển thị các danh mục có dữ liệu
    valid_categories = heatmap_data.columns[heatmap_data.sum() > 0]
    sns.heatmap(
        heatmap_data[valid_categories].T,
        cmap='Blues',
        annot=True,
        fmt='.0f',
        linewidths=0.5,
        cbar_kws={'label': 'Số lượng video'}
    )
    plt.title('VIDEO TRENDING THEO NGÀY VÀ DANH MỤC', pad=20, fontweight='bold', fontsize=14)
    plt.xlabel('Ngày trong tuần', fontsize=12)
    plt.ylabel('Danh mục', fontsize=12)
    
    # --- BIỂU ĐỒ 2: GIỜ ĐĂNG PHỔ BIẾN THEO DANH MỤC ---
    plt.subplot(1, 2, 2)
    hour_data = df.groupby(['category_name', 'publish_hour']).size().unstack().fillna(0)
    
    # Chọn top 10 danh mục để trực quan hóa rõ ràng
    top_categories = hour_data.sum(axis=1).nlargest(10).index
    hour_data.loc[top_categories].T.plot(
        kind='area',
        stacked=True,
        alpha=0.7,
        colormap='tab20',
        linewidth=0
    )
    plt.title('GIỜ ĐĂNG VIDEO PHỔ BIẾN THEO DANH MỤC', pad=20, fontweight='bold', fontsize=14)
    plt.xlabel('Giờ trong ngày', fontsize=12)
    plt.ylabel('Số lượng video', fontsize=12)
    plt.legend(bbox_to_anchor=(1.05, 1), title='Danh mục')
    plt.grid(alpha=0.3)
    plt.xticks(range(0, 24, 2))
    
    plt.tight_layout()
    plt.savefig('trending_analysis_2charts.png', dpi=150, bbox_inches='tight')
    print("✅ Đã lưu biểu đồ vào: trending_analysis_2charts.png")

# Chạy phân tích
analyze_trending_patterns('BR_youtube_trending_data.csv', 'BR_category_id.json')
