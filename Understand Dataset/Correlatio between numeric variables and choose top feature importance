import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
import numpy as np
from TrainingModel import best_model_name, X_train, y_train, models


# 1. Chuáº©n bá»‹ dá»¯ liá»‡u
# Táº£i láº¡i dá»¯ liá»‡u gá»‘c Ä‘á»ƒ láº¥y thÃªm cÃ¡c cá»™t nhÆ° title_length, tag_count, publish_hour
df = pd.read_csv('preprocessed_youtube_trending_data.csv')

# TÃ­nh toÃ¡n cÃ¡c Ä‘áº·c trÆ°ng bá»• sung
# title_length
df['title_length'] = df['title'].apply(len)

# tag_count
df['tag_count'] = df['tags'].apply(lambda x: len(str(x).split('|')) if x != '[none]' else 0)

# publish_hour
df['publishedAt'] = pd.to_datetime(df['publishedAt'])
df['publish_hour'] = df['publishedAt'].dt.hour

# hours_to_trend
df['trending_date'] = pd.to_datetime(df['trending_date'])
df['hours_to_trend'] = (df['trending_date'] - df['publishedAt']).dt.total_seconds() / 3600

# Lá»c cÃ¡c cá»™t cáº§n thiáº¿t cho heatmap (dá»±a trÃªn hÃ¬nh báº¡n cung cáº¥p)
numeric_vars = ['view_count', 'likes', 'comment_count', 'title_length', 'tag_count', 'publish_hour', 'hours_to_trend']
data_for_heatmap = df[numeric_vars]

# 2. TÃ­nh ma tráº­n tÆ°Æ¡ng quan giá»¯a cÃ¡c biáº¿n sá»‘
corr_matrix = data_for_heatmap.corr()

# 3. Váº½ heatmap tÆ°Æ¡ng quan giá»¯a cÃ¡c biáº¿n
plt.figure(figsize=(10, 8))
sns.heatmap(
    corr_matrix,
    annot=True,           # Hiá»ƒn thá»‹ giÃ¡ trá»‹ trÃªn Ã´
    cmap='coolwarm',      # Thang mÃ u tá»« xanh (Ã¢m) Ä‘áº¿n Ä‘á» (dÆ°Æ¡ng)
    vmin=-1, vmax=1,      # Giá»›i háº¡n thang mÃ u tá»« -1 Ä‘áº¿n 1
    center=0,             # Äáº·t giÃ¡ trá»‹ 0 á»Ÿ giá»¯a thang mÃ u
    fmt='.2f',            # Äá»‹nh dáº¡ng 2 chá»¯ sá»‘ tháº­p phÃ¢n
    square=True,          # Äáº£m báº£o cÃ¡c Ã´ lÃ  hÃ¬nh vuÃ´ng
    cbar_kws={'label': 'Correlation'}  # NhÃ£n cho thanh mÃ u
)
plt.title('Correlation Between Numeric Variables')
plt.tight_layout()
plt.savefig('correlation_heatmap.png')
plt.show()

# 4. TÃ­nh correlation giá»¯a cÃ¡c Ä‘áº·c trÆ°ng vÃ  target (view_velocity)
# Sá»­ dá»¥ng X_train vÃ  y_train tá»« TrainingModel
corr_with_target = pd.DataFrame({
    'Feature': X_train.columns,
    'Correlation_with_Target': [X_train[col].corr(y_train) for col in X_train.columns]
}).sort_values('Correlation_with_Target', key=abs, ascending=False)

# 5. Káº¿t há»£p vá»›i feature importance tá»« best model
best_model = models[best_model_name]
if hasattr(best_model, 'feature_importances_'):
    corr_with_target['Importance'] = best_model.feature_importances_
elif hasattr(best_model, 'coef_'):
    corr_with_target['Importance'] = np.abs(best_model.coef_.flatten())
else:
    corr_with_target['Importance'] = 0  # Náº¿u mÃ´ hÃ¬nh khÃ´ng cÃ³ feature importance

# 6. TÃ­nh Ä‘iá»ƒm tá»•ng há»£p (Composite Score) Ä‘á»ƒ xáº¿p háº¡ng Ä‘áº·c trÆ°ng
corr_with_target['Composite_Score'] = (
    corr_with_target['Correlation_with_Target'].abs() * corr_with_target['Importance']
)
top_features = corr_with_target.sort_values('Composite_Score', ascending=False).head(10)

# 7. Visualize top features báº±ng bar plot
plt.figure(figsize=(12, 6))
sns.barplot(
    x='Composite_Score',
    y='Feature',
    data=top_features,
    palette='viridis'
)
plt.title('Top Features Affecting view_velocity\n(Correlation + Model Importance)')
plt.xlabel('Combined Importance Score')
plt.tight_layout()
plt.savefig('top_features_barplot.png')
plt.show()

# 8. In káº¿t quáº£
most_important_feature = top_features.iloc[0]['Feature']
print(f"\nğŸ” MOST IMPORTANT FEATURE TO 'view_velocity': {most_important_feature}")
print("\nğŸ“Š Top 10 Features Summary:")
print(top_features[['Feature', 'Correlation_with_Target', 'Importance', 'Composite_Score']].round(3))
